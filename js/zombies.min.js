log.setLevel("debug");zombies={inProgress:false,currentTime:0,zombiesAdded:0,init:function(){log.debug("Initializing zombies");new Promise(zombies.getInitialData).then(function(){log.debug("Done getting initial data");zombies.setupMap(function(){zombieModel.setup()})},function(a){log.error(a)});$("#calculateSubmit").click(zombies.onLaunchClick);$("#calculateReset").click(zombies.onResetClick)},setupMap:function(a){log.debug("Setting up map");zombies.currentTime=0;zombies.mapObject=new jvm.MultiMap({container:$("#map"),maxLevel:1,main:{map:"us_lcc_en",backgroundColor:"transparent",onRegionTipShow:zombies.onRegionTipShow,onRegionClick:zombies.onRegionClick,series:{regions:[{scale:["#99ff99","#990000"],attribute:"fill",values:zombies.percentages[zombies.currentTime],min:0,max:100,legend:{horizontal:true,title:"Percentage taken over by zombies"}},{scale:["#4682B4 ","#990000"],attribute:"fill",values:zombies.lakeCodes,min:0,max:100}]}},mapUrlByCode:function(c,d){var b=c.toLowerCase()+"_lcc_en";updateMap=function(){setTimeout(function(){if(zombies.mapObject.maps[b]){zombies.mapObject.maps[b].series.regions[0].setValues(zombies.percentages[zombies.currentTime])}else{updateMap()}},100)};updateMap();return"data/counties/jquery-jvectormap-data-"+c.toLowerCase()+"-"+d.defaultProjection+"-en.js"}});$("#map").bind("regionClick.jvectormap",zombies.onRegionClick);a()},onRegionTipShow:function(d,a,c){if(c in zombies.lakeCodes){return}zombies.currentLabel=a;zombies.currentHoverState=a.html();try{if(zombies.inProgress){a.html("<b>"+a.html()+"</b></br><b>Zombie takeover: </b>"+zombies.percentages[zombies.currentTime][c]+"% </b></br><b>Human Population: </b>"+Number(zombies.populations[zombies.currentTime][c].humans).toLocaleString()+"</b></br><b>Zombie Population: </b>"+Number(zombies.populations[zombies.currentTime][c].zombies).toLocaleString())}else{a.html("<b>"+a.html()+"</b></br><b>Population: </b>"+Number(zombies.populations[zombies.currentTime][c].humans).toLocaleString()+"</b></br><b>Initial Zombies: </b>"+zombies.populations[zombies.currentTime][c].zombies)}}catch(b){}},onRegionClick:function(c,b){if(zombies.inProgress||b in zombies.lakeCodes){return}if(zombies.isCodeState(b)){return}var e=Number(document.getElementById("deltaClick").value);var a=zombies.populations["0"][b];var f=zombies.countyState[b];var d=zombies.populations["0"][f];if(a.humans>e){a.humans-=e;a.zombies+=e;d.humans-=e;d.zombies+=e;zombies.zombiesAdded+=e}else{a.zombies+=a.humans;d.humans-=a.humans;d.zombies+=a.humans;zombies.zombiesAdded+=a.humans;a.humans=0}zombies.populations["0"][b]=a;zombies.populations["0"][f]=d;zombies.percentages["0"][b]=zombies.zombiePercentage(a.zombies,a.humans);zombies.percentages["0"][f]=zombies.zombiePercentage(d.zombies,d.humans);zombies.currentLabel.html("<b>"+zombies.currentHoverState+"</b></br><b>Population: </b>"+Number(zombies.populations[zombies.currentTime][b].humans).toLocaleString()+"</b></br><b>Initial Zombies: </b>"+zombies.populations[zombies.currentTime][b].zombies)},onLaunchClick:function(){if(zombies.zombiesAdded==0){window.alert("No zombies added!");return}log.debug("Launching");zombies.inProgress=true;document.getElementById("calculateSubmit").style.display="none";$("#map").addClass("loading");zombies.maxTime=document.getElementById("timeMax").value;new Promise(zombies.calculateSimulation).then(zombies.showSimulation);if(!zombies.spinner){zombies.spinner=new Spinner()}zombies.spinner.spin();document.getElementById("zombie-settings-params").appendChild(zombies.spinner.el)},onResetClick:function(){log.debug("Resetting");zombies.inProgress=false;zombies.zombiesAdded=0;zombies.currentTime=0;document.getElementById("calculateSubmit").style.display="block";document.getElementById("div-runtime").style.display="none";document.getElementById("curTimeValue").innerHTML=zombies.currentTime;new Promise(zombies.getInitialData).then(function(){zombies.forEachMap(function(a){a.series.regions[0].setValues(zombies.percentages["0"])})})},showSimulation:function(){log.debug("Start simulation");$("#map").removeClass("loading");zombies.spinner.stop();document.getElementById("div-runtime").style.display="block";$("#slider-simulator").slider({value:zombies.currentTime,min:0,max:document.getElementById("timeMax").value,step:1,slide:zombies.onSimulatorSlider})},onSimulatorSlider:function(a,b){zombies.currentTime=b.value;document.getElementById("curTimeValue").innerHTML=b.value;zombies.forEachMap(function(c){c.series.regions[0].setValues(zombies.percentages[b.value])})},calculateSimulation:function(c){log.info("Calculating Simulation");for(var a=0;a<zombies.maxTime;a++){zombies.percentages[a+1]={};zombies.populations[a+1]={};for(var d in zombies.statesCounties){zombies.populations[a+1][d]={};zombies.populations[a+1][d]={};var b=zombies.statesCounties[d];b.forEach(function(e){zombies.populations[a+1][e]={}})}}zombies.calcAllStatesNextIteration(0,function(){c()})},calcAllStatesNextIteration:function(b,a){if(b>=zombies.maxTime){a();return}var d=[];for(var e in zombies.statesCounties){var c=Q.defer();zombies.calculateStateNextIteration(e,b,function(f){c.resolve(f)});d.push(c.promise)}Q.all(d).then(function(f){b++;zombies.calcAllStatesNextIteration(b,a)})},calculateStateNextIteration:function(h,b,e){var d=zombies.statesCounties[h];var g=[];var a=0;var c=0;d.forEach(function(k){var j=zombies.populations[b][k];var i=[];try{zombies.countyNeighbors[k].forEach(function(m){i.push(zombies.populations[b][m])})}catch(l){log.warn("calculateStateNextIteration",l," countyCode: ",k)}finally{results=zombieModel.nextIteration(j,i);zombies.populations[b+1][k].humans=results.humans;zombies.populations[b+1][k].zombies=results.zombies;zombies.percentages[b+1][k]=zombies.zombiePercentage(results.zombies,results.humans);g.push(zombies.percentages[b+1][k]);a+=results.humans;c+=results.zombies}});var f=zombies.getArrayAverage(g);a=zombies.roundNumber(a);c=zombies.roundNumber(c);zombies.populations[b+1][h].humans=((a<0)?0:a);zombies.populations[b+1][h].zombies=((c<0)?0:c);zombies.percentages[b+1][h]=f;e(b)},getInitialData:function(b,a){log.info("Loading data files");$.when($.getJSON("data/percentages.json"),$.getJSON("data/populations.json"),$.getJSON("data/states-counties.json"),$.getJSON("data/county-adjacent.json"),$.getJSON("data/county-state.json"),$.getJSON("data/lake-codes.json")).done(function(d,h,f,g,e,c){log.info("Preparing data");if(d["1"]!="success"){a("Could not load data/percentages.json")}if(h["1"]!="success"){a("Could not load data/populations.json")}if(f["1"]!="success"){a("Could not load data/states-counties.json")}if(g["1"]!="success"){a("Could not load data/county-adjacent.json")}if(e["1"]!="success"){a("Could not load data/county-state.json")}if(c["1"]!="success"){a("Could not load data/lake-codes.json")}zombies.percentages={"0":d["0"]};zombies.populations={"0":h["0"]};zombies.statesCounties=f["0"];zombies.countyNeighbors=g["0"];zombies.countyState=e["0"];zombies.lakeCodes=c["0"];b()})},mergeObjects:function(d,c){var b={};for(var a in d){b[a]=d[a]}for(var a in c){b[a]=c[a]}return b},roundNumber:function(a){return Number(a).toFixed(2)},zombiePercentage:function(b,c){if(b<=0){return 0}if(c<=0){return 100}var a=b/(c+b);a=a*100;return Number(zombies.roundNumber(a))},getArrayAverage:function(a){var b=0;a.forEach(function(c){b+=c});if(b==0){return 0}else{return Number(zombies.roundNumber(b/a.length))}},isCodeState:function(a){return a.substring(0,2)=="US"},forEachMap:function(a){for(var b in zombies.mapObject.maps){a(zombies.mapObject.maps[b])}},methodEntry:function(){log.debug("Method Entry:",zombies.methodEntry.caller.name)},methodExit:function(){log.debug("Method Exit:",zombies.methodExit.caller.name)}};