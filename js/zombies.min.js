log.setLevel("info");zombies={inProgress:false,currentTime:0,init:function(){log.debug("Initializing zombies");new Promise(zombies.getInitialData).then(function(){log.debug("Done getting initial data");zombies.setupMap(function(){zombieModel.setup()})},function(a){log.error(a)});$("#calculateSubmit").click(zombies.onLaunchClick);$("#calculateReset").click(zombies.onResetClick)},setupMap:function(a){log.debug("Setting up map");zombies.currentTime=0;zombies.mapObject=new jvm.Map({container:$("#map"),map:"us_aea",backgroundColor:"transparent",onRegionTipShow:zombies.onRegionTipShow,onRegionClick:zombies.onRegionClick,series:{regions:[{scale:["#99ff99","#990000"],attribute:"fill",values:zombies.percentages[zombies.currentTime],min:0,max:100,legend:{horizontal:true,title:"Percentage taken over by zombies"}}]}});a()},onRegionTipShow:function(d,a,c){zombies.currentLabel=a;zombies.currentHoverState=a.html();try{if(zombies.inProgress){a.html("<b>"+a.html()+"</b></br><b>Zombie takeover: </b>"+zombies.percentages[zombies.currentTime][c]+"% </b></br><b>Human Population: </b>"+Number(zombies.populations[zombies.currentTime][c].humans).toLocaleString()+"</b></br><b>Zombie Population: </b>"+Number(zombies.populations[zombies.currentTime][c].zombies).toLocaleString())}else{a.html("<b>"+a.html()+"</b></br><b>Population: </b>"+Number(zombies.populations[zombies.currentTime][c].humans).toLocaleString()+"</b></br><b>Initial Zombies: </b>"+zombies.populations[zombies.currentTime][c].zombies)}}catch(b){}},onRegionClick:function(d,c){if(zombies.inProgress){return}var f=100;var e=zombies.statesCounties[c];var a=0;var b=0;e.forEach(function(j){var g=zombies.populations["0"][j];var i=g.humans;var h=g.zombies;if(i>f){i=i-f;h=h+f;zombies.percentages["0"][j]=zombies.roundNumber((h/(i+h)*100))}else{h=h+i;i=0;zombies.percentages["0"][j]=0}zombies.populations["0"][j].humans=i;zombies.populations["0"][j].zombies=h;a+=i;b+=h});zombies.populations["0"][c].humans=a;zombies.populations["0"][c].zombies=b;zombies.percentages["0"][c]=zombies.roundNumber((b/(a+b)*100));zombies.mapObject.series.regions[0].setValues(zombies.percentages[0]);zombies.currentLabel.html("<b>"+zombies.currentHoverState+"</b></br><b>Population: </b>"+Number(zombies.populations[zombies.currentTime][c].humans).toLocaleString()+"</b></br><b>Initial Zombies: </b>"+zombies.populations[zombies.currentTime][c].zombies)},onLaunchClick:function(){log.debug("Launching");zombies.inProgress=true;document.getElementById("calculateSubmit").style.display="none";$("#map").addClass("loading");zombies.maxTime=document.getElementById("timeMax").value;new Promise(zombies.calculateSimulation).then(zombies.showSimulation)},onResetClick:function(){log.debug("Resetting");zombies.inProgress=false;zombies.currentTime=0;document.getElementById("calculateSubmit").style.display="block";document.getElementById("div-runtime").style.display="none";document.getElementById("curTimeValue").innerHTML=zombies.currentTime;zombies.mapObject.remove();zombies.init()},showSimulation:function(){log.debug("Start simulation");$("#map").removeClass("loading");document.getElementById("div-runtime").style.display="block";$("#slider-simulator").slider({value:zombies.currentTime,min:0,max:document.getElementById("timeMax").value,step:1,slide:zombies.onSimulatorSlider})},onSimulatorSlider:function(a,b){zombies.currentTime=b.value;document.getElementById("curTimeValue").innerHTML=b.value;zombies.mapObject.series.regions[0].setValues(zombies.percentages[b.value])},calculateSimulation:function(c){log.info("Calculating Simulation");for(var a=0;a<zombies.maxTime;a++){zombies.percentages[a+1]={};zombies.populations[a+1]={};for(var d in zombies.statesCounties){zombies.populations[a+1][d]={};zombies.populations[a+1][d]={};var b=zombies.statesCounties[d];b.forEach(function(e){zombies.populations[a+1][e]={}})}}zombies.calcAllStatesNextIteration(0,function(){c()})},calcAllStatesNextIteration:function(b,a){if(b>=zombies.maxTime){a();return}var d=[];for(var e in zombies.statesCounties){var c=Q.defer();zombies.calculateStateNextIteration(e,b,function(f){c.resolve(f)});d.push(c.promise)}Q.all(d).then(function(f){b++;zombies.calcAllStatesNextIteration(b,a)})},calculateStateNextIteration:function(g,b,e){var d=zombies.statesCounties[g];var a=0;var c=0;d.forEach(function(j){var i=zombies.populations[b][j];var h=[];try{zombies.countyNeighbors[j].forEach(function(l){h.push(zombies.populations[b][l])})}catch(k){log.warn("calculateStateNextIteration",k," countyCode: ",j)}finally{results=zombieModel.nextIteration(i,h);zombies.populations[b+1][j].humans=results.humans;zombies.populations[b+1][j].zombies=results.zombies;a+=results.humans;c+=results.zombies}});var f=zombies.zombiePercentage(c,a);a=zombies.roundNumber(a);c=zombies.roundNumber(c);zombies.populations[b+1][g].humans=((a<0)?0:a);zombies.populations[b+1][g].zombies=((c<0)?0:c);zombies.percentages[b+1][g]=f;e(b)},getInitialData:function(b,a){log.info("Loading data files");$.when($.getJSON("data/percentages.json"),$.getJSON("data/populations.json"),$.getJSON("data/states-counties.json"),$.getJSON("data/county-adjacent.json")).done(function(c,f,d,e){log.info("Preparing data");if(c["1"]!="success"){a("Could not load data/percentages.json")}if(f["1"]!="success"){a("Could not load data/populations.json")}if(d["1"]!="success"){a("Could not load data/states-counties.json")}if(e["1"]!="success"){a("Could not load data/county-adjacent.json")}zombies.percentages={"0":c["0"]};zombies.populations={"0":f["0"]};zombies.statesCounties=d["0"];zombies.countyNeighbors=e["0"];b()})},mergeObjects:function(d,c){var b={};for(var a in d){b[a]=d[a]}for(var a in c){b[a]=c[a]}return b},roundNumber:function(a){return Number(a).toFixed(2)},zombiePercentage:function(b,c){if(b<=0){return 0}if(c<=0){return 100}var a=b/(c+b);a=a*100;return Number(zombies.roundNumber(a))},methodEntry:function(){log.debug("Method Entry:",zombies.methodEntry.caller.name)},methodExit:function(){log.debug("Method Exit:",zombies.methodExit.caller.name)}};
